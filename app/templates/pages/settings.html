{% extends 'layouts/base.html' %}

{% block title %}Settings - Family Office Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2 class="mb-0">Settings</h2>
        <p class="text-muted">Configure your application preferences</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-3">
        <!-- Settings Navigation -->
        <div class="list-group mb-4">
            <a href="#display" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                <i class="bi bi-display me-2"></i>Display
            </a>
            <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list">
                <i class="bi bi-bell me-2"></i>Notifications
            </a>
            <a href="#agents" class="list-group-item list-group-item-action" data-bs-toggle="list">
                <i class="bi bi-robot me-2"></i>AI Agents
            </a>
            <a href="#data" class="list-group-item list-group-item-action" data-bs-toggle="list">
                <i class="bi bi-database me-2"></i>Data & Sync
            </a>
            <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="list">
                <i class="bi bi-shield-lock me-2"></i>Security
            </a>
        </div>
    </div>

    <div class="col-lg-9">
        <div class="tab-content">
            <!-- Display Settings -->
            <div class="tab-pane fade show active" id="display">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="mb-0"><i class="bi bi-display me-2"></i>Display Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label">Theme</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="theme" id="themeLight" value="light">
                                <label class="btn btn-outline-primary" for="themeLight">
                                    <i class="bi bi-sun me-1"></i>Light
                                </label>
                                <input type="radio" class="btn-check" name="theme" id="themeDark" value="dark">
                                <label class="btn btn-outline-primary" for="themeDark">
                                    <i class="bi bi-moon me-1"></i>Dark
                                </label>
                                <input type="radio" class="btn-check" name="theme" id="themeAuto" value="auto" checked>
                                <label class="btn btn-outline-primary" for="themeAuto">
                                    <i class="bi bi-circle-half me-1"></i>Auto
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Currency Display</label>
                            <select class="form-select" id="currency">
                                <option value="USD" selected>USD ($)</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Date Format</label>
                            <select class="form-select" id="dateFormat">
                                <option value="MM/DD/YYYY" selected>MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                            </select>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="compactMode">
                            <label class="form-check-label" for="compactMode">Compact Mode</label>
                            <div class="form-text">Use smaller fonts and reduced spacing</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="tab-pane fade" id="notifications">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="mb-0"><i class="bi bi-bell me-2"></i>Notification Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="emailAlerts" checked>
                            <label class="form-check-label" for="emailAlerts">Email Alerts</label>
                            <div class="form-text">Receive important alerts via email</div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="portfolioAlerts" checked>
                            <label class="form-check-label" for="portfolioAlerts">Portfolio Alerts</label>
                            <div class="form-text">Get notified of significant portfolio changes</div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="agentAlerts" checked>
                            <label class="form-check-label" for="agentAlerts">AI Agent Alerts</label>
                            <div class="form-text">Receive recommendations from AI agents</div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="marketAlerts">
                            <label class="form-check-label" for="marketAlerts">Market Alerts</label>
                            <div class="form-text">Get notified of major market movements</div>
                        </div>

                        <div class="mt-4">
                            <label class="form-label">Alert Threshold</label>
                            <input type="range" class="form-range" id="alertThreshold" min="1" max="10" value="5">
                            <div class="d-flex justify-content-between text-muted small">
                                <span>More Alerts</span>
                                <span>Fewer Alerts</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Agent Settings -->
            <div class="tab-pane fade" id="agents">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Agent Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label">Analysis Frequency</label>
                            <select class="form-select" id="analysisFrequency">
                                <option value="realtime">Real-time</option>
                                <option value="daily" selected>Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="manual">Manual Only</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Confidence Threshold</label>
                            <input type="range" class="form-range" id="confidenceThreshold" min="50" max="95" value="70">
                            <div class="text-center"><span id="confidenceValue">70</span>%</div>
                            <div class="form-text">Only show recommendations above this confidence level</div>
                        </div>

                        <h6 class="mb-3">Active Agents</h6>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="cfaAgent" checked>
                            <label class="form-check-label" for="cfaAgent">CFA Investment Analyst</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="cfpAgent" checked>
                            <label class="form-check-label" for="cfpAgent">CFP Financial Planner</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="cioAgent" checked>
                            <label class="form-check-label" for="cioAgent">Chief Investment Officer</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="accountantAgent" checked>
                            <label class="form-check-label" for="accountantAgent">Tax Accountant</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="quantRiskAgent" checked>
                            <label class="form-check-label" for="quantRiskAgent">Quantitative Risk Analyst</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="quantStrategyAgent" checked>
                            <label class="form-check-label" for="quantStrategyAgent">Quantitative Strategy Analyst</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Settings -->
            <div class="tab-pane fade" id="data">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="mb-0"><i class="bi bi-database me-2"></i>Data & Sync Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label">Price Update Frequency</label>
                            <select class="form-select" id="priceFrequency">
                                <option value="1">Every minute</option>
                                <option value="5" selected>Every 5 minutes</option>
                                <option value="15">Every 15 minutes</option>
                                <option value="60">Every hour</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <h6>Data Sources</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="sourceYahoo" checked disabled>
                                <label class="form-check-label" for="sourceYahoo">Yahoo Finance (Default)</label>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="syncNow()">
                                <i class="bi bi-arrow-repeat me-1"></i>Sync Now
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearCache()">
                                <i class="bi bi-trash me-1"></i>Clear Cache
                            </button>
                        </div>

                        <div class="mt-4">
                            <h6>Export Data</h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-file-earmark-spreadsheet me-1"></i>Export CSV
                                </button>
                                <button class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-file-earmark-pdf me-1"></i>Export PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Settings -->
            <div class="tab-pane fade" id="security">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Security Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="twoFactor">
                            <label class="form-check-label" for="twoFactor">Two-Factor Authentication</label>
                            <div class="form-text">Add an extra layer of security to your account</div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Session Timeout</label>
                            <select class="form-select" id="sessionTimeout">
                                <option value="15">15 minutes</option>
                                <option value="30" selected>30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="1440">24 hours</option>
                            </select>
                        </div>

                        <div class="mt-4">
                            <h6>Active Sessions</h6>
                            <div class="list-group">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-laptop me-2"></i>
                                        <strong>Current Session</strong>
                                        <br><small class="text-muted">Chrome on macOS</small>
                                    </div>
                                    <span class="badge bg-success">Active</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-outline-danger" onclick="logoutAllSessions()">
                                <i class="bi bi-box-arrow-right me-1"></i>Logout All Sessions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="mt-4">
            <button class="btn btn-primary" onclick="saveSettings()">
                <i class="bi bi-check-lg me-1"></i>Save All Settings
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize settings from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const settings = FamilyOffice.getStorageItem('settings', {});

    // Apply saved settings
    if (settings.theme) {
        document.querySelector(`input[name="theme"][value="${settings.theme}"]`).checked = true;
    }

    // Confidence threshold slider
    document.getElementById('confidenceThreshold').addEventListener('input', function() {
        document.getElementById('confidenceValue').textContent = this.value;
    });
});

function saveSettings() {
    const settings = {
        theme: document.querySelector('input[name="theme"]:checked').value,
        currency: document.getElementById('currency').value,
        dateFormat: document.getElementById('dateFormat').value,
        compactMode: document.getElementById('compactMode').checked,
        analysisFrequency: document.getElementById('analysisFrequency').value,
        confidenceThreshold: document.getElementById('confidenceThreshold').value
    };

    FamilyOffice.setStorageItem('settings', settings);
    FamilyOffice.showToast('Settings saved successfully', 'success');
}

async function syncNow() {
    try {
        const response = await fetch('/api/v1/admin/sync', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            FamilyOffice.showToast('Sync completed', 'success');
        } else {
            FamilyOffice.showToast('Sync failed', 'danger');
        }
    } catch (error) {
        FamilyOffice.showToast('An error occurred', 'danger');
    }
}

async function clearCache() {
    try {
        const response = await fetch('/api/v1/admin/clear-cache', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            FamilyOffice.showToast('Cache cleared', 'success');
        } else {
            FamilyOffice.showToast('Failed to clear cache', 'danger');
        }
    } catch (error) {
        FamilyOffice.showToast('An error occurred', 'danger');
    }
}

function logoutAllSessions() {
    FamilyOffice.confirmAction(
        'Are you sure you want to logout from all sessions?',
        () => {
            FamilyOffice.showToast('All sessions logged out', 'success');
        }
    );
}
</script>
{% endblock %}
